# AKS Cluster Terraform Module

This module handles the creation and management of an Azure Kubernetes Service (AKS) cluster, including node pools, workload identities, and addons.

## Requirements

- Terraform 0.13+
- Azure CLI
- Azure subscription

## Providers

| Name       | Version |
| ---------- | ------- |
| azurerm    | 4.14.0  |
| kubernetes | 2.7.1   |

## Resources

| Name                                                                                                                                                                     | Type     |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------- |
| [azurerm_kubernetes_cluster.aks](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster)                                     | resource |
| [azurerm_kubernetes_cluster_node_pool.nodepool_resource](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster_node_pool)   | resource |
| [azurerm_user_assigned_identity.workload_identity](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/user_assigned_identity)               | resource |
| [azurerm_federated_identity_credential.workload_identity](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/federated_identity_credential) | resource |
| [azurerm_key_vault.workload_identity_key_vault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault)                               | resource |
| [azurerm_role_assignment.workload_identity_role_assignment](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment)             | resource |

## Inputs

| Name                                      | Description                                                                                                        | Type                                                                                                                                                                           | Default                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Required |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------: |
| resource_group                            | The resource group name                                                                                            | `string`                                                                                                                                                                       | `"dev-rg-ci"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |   yes    |
| cluster_name                              | The name of the cluster (required)                                                                                 | `string`                                                                                                                                                                       | `"dev-caas-1"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |   yes    |
| location                                  | The location of the cluster (required)                                                                             | `string`                                                                                                                                                                       | `"centralindia"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |   yes    |
| kubernetes_version                        | The Kubernetes version of the cluster                                                                              | `string`                                                                                                                                                                       | `"1.30.7"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |   yes    |
| cluster_tags                              | Tags to apply to the cluster                                                                                       | `map(string)`                                                                                                                                                                  | `{ environment = "dev", email = "cloudengg@rafay.co" }`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| aks_pricing_tier                          | AKS pricing tier                                                                                                   | `string`                                                                                                                                                                       | `"Free"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |    no    |
| user_managed_identity                     | User managed identity for the cluster                                                                              | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| log_analytics_workspace_id                | Log Analytics Workspace ID                                                                                         | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| automatic_upgrade_channel                 | The upgrade channel for automatic upgrades                                                                         | `string`                                                                                                                                                                       | `"stable"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |    no    |
| network_plugin                            | Network plugin to use for networking                                                                               | `string`                                                                                                                                                                       | `"azure"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| network_policy                            | Network policy to use for networking                                                                               | `string`                                                                                                                                                                       | `"azure"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |    no    |
| network_plugin_mode                       | Network plugin mode to use for networking                                                                          | `string`                                                                                                                                                                       | `"overlay"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |    no    |
| private_cluster_enabled                   | Enable private cluster                                                                                             | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| private_cluster_public_fqdn_enabled       | Enable private cluster public FQDN                                                                                 | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| private_dns_zone_id                       | Private DNS zone                                                                                                   | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| temporary_name_for_rotation               | Temporary name for rotation when changing the kubelet_config block                                                 | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| http_application_routing_enabled          | Should HTTP Application Routing be enabled?                                                                        | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| azure_policy_enabled                      | Should Azure Policy be enabled?                                                                                    | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| oidc_issuer_enabled                       | Should OIDC issuer be enabled?                                                                                     | `bool`                                                                                                                                                                         | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |    no    |
| default_node_pool                         | Configuration for the default node pool                                                                            | `object`                                                                                                                                                                       | `{ name = "default", node_count = 1, vm_size = "Standard_DS2_v2", max_pods = 30, availability_zones = ["1", "2", "3"], node_public_ip_enabled = false, vnet_subnet_id = "", pod_subnet_id = "", os_sku = "Ubuntu", snapshot_id = "" }`                                                                                                                                                                                                                                                                                                                                     |    no    |
| node_pools                                | List of maps containing node pools                                                                                 | `any`                                                                                                                                                                          | `{ p1 = { min_count = 2, max_count = 2, node_count = 2, auto_scaling_enabled = true, vm_size = "Standard_B4ms", max_pods = 110, availability_zones = ["1", "2", "3"], node_public_ip_enabled = false, vnet_subnet_id = "", pod_subnet_id = "", os_sku = "Ubuntu", snapshot_id = "" }, p2 = { min_count = 2, max_count = 2, node_count = 2, auto_scaling_enabled = true, vm_size = "Standard_B4ms", max_pods = 110, availability_zones = ["1", "2", "3"], node_public_ip_enabled = false, vnet_subnet_id = "", pod_subnet_id = "", os_sku = "Ubuntu", snapshot_id = "" } }` |    no    |
| kubelet_config                            | Kubelet configuration for the node pool                                                                            | `object`                                                                                                                                                                       | `{ cpu_manager_policy = "static", cpu_cfs_quota_enabled = true, cpu_cfs_quota_period = "100ms", image_gc_high_threshold = 85, image_gc_low_threshold = 80, topology_manager_policy = "best-effort", allowed_unsafe_sysctls = [], container_log_max_line = 10, container_log_max_size_mb = 10, pod_max_pid = 100 }`                                                                                                                                                                                                                                                         |    no    |
| maintenance_window_auto_upgrade           | Configuration for the maintenance window auto upgrade                                                              | `object`                                                                                                                                                                       | `{ frequency = "Weekly", interval = 1, duration = 4, day_of_week = "Sunday", day_of_month = null, week_index = null, start_time = "00:00", utc_offset = "+00:00", start_date = null, not_allowed = [] }`                                                                                                                                                                                                                                                                                                                                                                   |    no    |
| maintenance_window_node_os                | Configuration for the maintenance window node OS                                                                   | `object`                                                                                                                                                                       | `{ frequency = "Weekly", interval = 1, duration = 4, day_of_week = "Sunday", day_of_month = null, week_index = null, start_time = "00:00", utc_offset = "+00:00", start_date = null, not_allowed = [] }`                                                                                                                                                                                                                                                                                                                                                                   |    no    |
| node_os_upgrade_channel                   | The upgrade channel for this Kubernetes Cluster Nodes' OS Image                                                    | `string`                                                                                                                                                                       | `"NodeImage"`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |    no    |
| dns_prefix                                | DNS prefix for the cluster                                                                                         | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| authorized_ip_ranges                      | Set of authorized IP ranges to allow access to API server                                                          | `list(string)`                                                                                                                                                                 | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| aad_tenant_id                             | The Tenant ID used for Azure Active Directory Application                                                          | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| aad_admin_group_object_ids                | A list of Object IDs of Azure Active Directory Groups which should have Admin Role on the Cluster                  | `list(string)`                                                                                                                                                                 | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| aad_azure_rbac_enabled                    | Is Role Based Access Control based on Azure AD enabled?                                                            | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| workload_identity_enabled                 | Should workload identity be enabled?                                                                               | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| workload_identities                       | Map of workload identities with roles and service accounts                                                         | `map(object({ name = string, resource_group = string, sa_namespaces = list(object({ sa_name = string, sa_namespace = string })), tags = map(string), roles = list(string) }))` | `{ workload_identity_1 = { name = "workload-identity-1", resource_group = "dev-rg-ci", sa_namespaces = [ { sa_name = "sa1", sa_namespace = "namespace1" }, { sa_name = "sa2", sa_namespace = "namespace2" } ], tags = { environment = "dev" }, roles = ["Contributor"] }, workload_identity_2 = { name = "workload-identity-2", resource_group = "dev-rg-ci", sa_namespaces = [ { sa_name = "sa3", sa_namespace = "namespace3" } ], tags = { environment = "prod" }, roles = ["Reader"] } }`                                                                               |    no    |
| enable_nginx_ingress                      | Enable NGINX Ingress Controller                                                                                    | `bool`                                                                                                                                                                         | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |    no    |
| web_app_routing_enabled                   | Should Web App Routing be enabled?                                                                                 | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| web_app_routing_dns_zone_ids              | List of DNS Zone IDs for Web App Routing                                                                           | `list(string)`                                                                                                                                                                 | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| service_mesh_profile_mode                 | The mode of the service mesh. Possible value is Istio.                                                             | `string`                                                                                                                                                                       | `Istio`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| service_mesh_profile_revisions            | Specify 1 or 2 Istio control plane revisions for managing minor upgrades using the canary upgrade process.         | `list(string)`                                                                                                                                                                 | `["asm-1-22"]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |    no    |
| internal_ingress_gateway_enabled          | Is Istio Internal Ingress Gateway enabled?                                                                         | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| external_ingress_gateway_enabled          | Is Istio External Ingress Gateway enabled?                                                                         | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| certificate_authority                     | Certificate authority configuration for Istio CA                                                                   | `object({ key_vault_id = string, root_cert_object_name = string, cert_chain_object_name = string, cert_object_name = string, key_object_name = string })`                      | `{ key_vault_id = "", root_cert_object_name = "", cert_chain_object_name = "", cert_object_name = "", key_object_name = "" }`                                                                                                                                                                                                                                                                                                                                                                                                                                              |    no    |
| key_vault_key_id                          | Identifier of Azure Key Vault key.                                                                                 | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| key_vault_network_access                  | Network access of the key vault. Possible values are Public and Private. Defaults to Public.                       | `string`                                                                                                                                                                       | `Public`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |    no    |
| secret_rotation_enabled                   | Should the secret store CSI driver on the AKS cluster be enabled?                                                  | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| secret_rotation_interval                  | The interval to poll for secret rotation. This attribute is only set when secret_rotation is true. Defaults to 2m. | `string`                                                                                                                                                                       | `2m`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| oms_agent_log_analytics_workspace_id      | The ID of the Log Analytics Workspace to use for the OMS agent.                                                    | `string`                                                                                                                                                                       | `""`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |
| oms_agent_msi_auth_for_monitoring_enabled | Should the OMS agent use MSI authentication for monitoring?                                                        | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| oms_agent                                 | Configuration for the OMS Agent                                                                                    | `object({ log_analytics_workspace_id = string, msi_auth_for_monitoring_enabled = bool })`                                                                                      | `{ log_analytics_workspace_id = "", msi_auth_for_monitoring_enabled = false }`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |    no    |
| kubelet_identity_enabled                  | Should kubelet identity be enabled?                                                                                | `bool`                                                                                                                                                                         | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |    no    |
| kubelet_identity                          | Configuration for the kubelet identity                                                                             | `object({ client_id = string, object_id = string, user_assigned_identity_id = string })`                                                                                       | `{ client_id = "", object_id = "", user_assigned_identity_id = "" }`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |    no    |

## Outputs

| Name                         | Description                                                                                                                             |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| resource_group_name          | AKS Resource Group                                                                                                                      |
| cluster_name                 | AKS Cluster Name                                                                                                                        |
| location                     | AKS Cluster Location                                                                                                                    |
| oidc_issuer_url              | The OIDC issuer URL of the AKS cluster                                                                                                  |
| workload_identity_client_ids | The client IDs of the created managed identities to use for the annotation 'azure.workload.identity/client-id' on your service accounts |
| kubelet_identity             | The kubelet identity configuration                                                                                                      |

## Usage

```hcl
module "aks_cluster" {
  source = "./path/to/module"

  resource_group            = "dev-rg-ci"
  cluster_name              = "dev-caas-1"
  location                  = "centralindia"
  kubernetes_version        = "1.30.7"
  aks_pricing_tier          = "Free"
  enable_nginx_ingress      = true
  automatic_upgrade_channel = "stable"
  network_plugin            = "azure"
  network_policy            = "azure"
  oidc_issuer_enabled       = true
  azure_policy_enabled      = false
  private_cluster_enabled   = false
  node_os_upgrade_channel   = "NodeImage"
  dns_prefix                = "dev-caas-1-k8s"
  authorized_ip_ranges      = ["0.0.0.0/0"]
  workload_identity_enabled = true
  workload_identities = {
    workload_identity_1 = {
      name           = "workload-identity-1"
      resource_group = "dev-rg-ci"
      sa_namespaces = [
        {
          sa_name      = "sa1"
          sa_namespace = "namespace1"
        },
        {
          sa_name      = "sa2"
          sa_namespace = "namespace2"
        }
      ]
      tags = {
        environment = "dev"
      }
      roles = ["Contributor"]
    },
    workload_identity_2 = {
      name           = "workload-identity-2"
      resource_group = "dev-rg-ci"
      sa_namespaces = [
        {
          sa_name      = "sa3"
          sa_namespace = "namespace3"
        }
      ]
      tags = {
        environment = "prod"
      }
      roles = ["Reader"]
    }
  }
  oms_agent = {
    log_analytics_workspace_id = "your-log-analytics-workspace-id"
    msi_auth_for_monitoring_enabled = true
  }
  kubelet_identity_enabled = true
  kubelet_identity = {
    client_id                = "your-client-id"
    object_id                = "your-object-id"
    user_assigned_identity_id = "your-user-assigned-identity-id"
  }
}
```

This module will create an AKS cluster with the specified configuration, including node pools, workload identities, kubelet identity, and addons such as NGINX Ingress Controller.
